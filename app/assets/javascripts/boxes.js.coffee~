# Place all the behaviors and hooks related to the matching controller here.
# All this logic will automatically be available in application.js.
# You can use CoffeeScript in this file: http://jashkenas.github.com/coffee-script/

jQuery ->

  # Alle Profilfelder auf der ganzen Seite werden durchgegangen:
  $( ".profile_field" ).each( ->

    # Die íd des Profilfeldes ist im id-Attribut des Spans gespeichert.
    id = $(this).attr( 'id' ).replace( "profile_field_", "" )

    # Die Url des Ajax-Aufrufs ist im Url-Attribut des Spans gespeichert.
    show_url = $(this).attr( 'url' )
    edit_url = show_url.replace( "show", "edit" )
    update_url = show_url.replace( "show", "update" )

    # Per Ajax wird der Show-View geladen. Wenn dies hier fehlt,
    # werden die Profilfelder auf den Profilseiten nicht gefüllt.
    $(this).load( show_url )

    # Methoden zum Anzeigen, Bearbeiten, etc. hinzufügen.
#    $.fn.edit = () ->
#      $(this).load( edit_url )

        # Aber das macht Blödsinn. Das fügt nämlich eine globale Funktion hinzu; nicht zu diesem Objekt.
        # So geht die url verloren.

    # Ein Doppelklick auf ein Profilfeld löst den Bearbeiten-Modus
    # für dieses Feld aus.
    $(this).dblclick( ->

      # Wenn das Feld schon im Bearbeiten-Modus ist,
      # die Ereignisse nicht nocheinmal zuweisen.
      return if $(this).find( ".edit" ).size() > 0

      $(this).load( edit_url, ->

        # Entfernen-Button
        $(this).find( ".remove_button" ).click( (event) ->
          $.ajax(
            url: $(this).attr( 'href' ),
            type: 'DELETE'
          )
          profile_field( id ).hide( 'blind' )
          clear_events_on_exit( id )
          event.preventDefault()
        )
      )

      # Ein Klick außerhalb lässt speichern.
      $(this).bind( "clickoutside", ->
        save_and_exit( id, update_url )
      )

      # ESC bricht ab.
      $(this).keyup( (event) ->
        if( event.keyCode == 27 )
          exit_edit_mode( id, show_url )
        if( event.keyCode == 13 )
          save_and_exit( id, update_url )
      )

    )

  )

  # Feld speichern und Bearbeiten-Modus verlassen,
  save_and_exit = ( id, update_url ) ->
    profile_field( id ).load( update_url,
      profile_field( id ).find( "form" ).serialize()
    )
    clear_events_on_exit( id )

  # Bearbeiten-Modus verlassen, ohne zu speichern.
  exit_edit_mode = ( id, show_url ) ->
    profile_field( id ).load( show_url )
    clear_events_on_exit( id )

  # Ereignis-Bindungen lösen, wenn der Bearbeiten-Modus verlassen wird.
  # Sonst würden die Ereignisse weiterhin aufgerufen werden.
  clear_events_on_exit = ( id ) ->
    profile_field( id ).keyup()
    profile_field( id ).bind( "clickoutside", null )

  profile_field = ( id ) ->
    $( "#profile_field_" + id )




  # Bearbeiten-Tools der Boxen ausblenden.
  $(".box_toolbar .button.hidden").hide()

  # Der Bearbeiten-Button der Box schaltet den Bearbeiten-Modus
  # für alle Felder in der Box ein.
  $(".box_edit_button").click( ->

    # Modaler Effekt
    modal_box = $(this).closest(".box")
    modal_box.addClass( "modal" )
    $("body").append( "<div class='modal_bg'></div>" )
    $("div.modal_bg").hide().fadeIn().click( ->
      # Wenn man auf den abgedunkelten Berreich außerhalb der Box klickt, wird
      # der Bearbeien-Modus beendet und gespeichert.
      modal_box.find(".box_save_button").click()
    )

    # Bearbeiten-Buttons umschalten.
    $(this).hide()
    $(this).parent().find(".box_save_button, .box_cancel_button").show()

    # Bearbeiten-Modus auf enthaltene Felder übertragen.
    profile_fields = $(this).closest(".box").find(".profile_field")

    profile_fields.each( ->
      $(this).find(".show").find("dt").text( "Bearbeiten-Modus-Test" )
    )

  )

  # Animation: Bearbeiten-Modus einer Box beenden.
  end_edit_mode_of_box = (box) ->
    box.find(".box_save_button, .box_cancel_button").hide()
    box.find(".box_edit_button").show()
    $("div.modal_bg").fadeOut( ->
      $(this).remove()
      $(".modal").removeClass("modal")
    )

  # Box speichern.
  $(".box_save_button").click( ->
    $(this).effect( "pulsate", { times: 2 }, "fast", ->
      end_edit_mode_of_box( $(this).closest( ".box" ) )
    )
  )

  # Box-Bearbeiten-Modus abbrechen.
  $(".box_cancel_button").click( ->
    $(this).effect( "pulsate", { times: 2 }, "fast", ->
      end_edit_mode_of_box( $(this).closest( ".box" ) )
    )
  )
